---
title: "Cycle Data Preprocessing"
author: "Myeong Lee"
date: "7/22/2017"
output: html_document
---

This script preprocess the cycle sensors data so that they can be used as features and classifiers.

```{r}
library(jsonlite)
library(readr)
library(dplyr)
library(sp)
library(ggplot2)
library(ggmap)
library(dplyr)
library(tidyr)
library(geosphere)
library(scales)

setwd("/Users/myeong/git/Atl_DSSG/Cycle-Atlanta-SLaB/DSSG2017_data/sample_data/Javier/")

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

gps <- read_delim("0722_prox_gps_join.csv", delim = ",", col_names = T)
prox <- read_delim("220717_prox.csv", delim = ",", col_names = T)
gps$id <- c(1:nrow(gps))
prox$id <- c(1:nrow(prox))

first <- gps[c(1:468),c("time", "lon", "lat", "video_time", "way", "speed", "LidarRight", "LidarLeft")]

LR <- ggplot(first, aes(x = video_time, y = LidarRight)) +
      geom_line() +
      geom_point(size = 0.5, color="red")  + 
      ylim(c(0,4000)) + scale_x_datetime(breaks=date_breaks("30 sec"), labels=date_format("%H:%M:%S")) +
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Video Time")  + ggtitle("Lidar Right (Video_time)") 

LL <- ggplot(first, aes(x = video_time, y = LidarLeft)) +
      geom_line() +
      geom_point( size = 0.5, color="red")  +
      ylim(c(0,4000))  + scale_x_datetime(breaks=date_breaks("30 sec"), labels=date_format("%H:%M:%S")) +
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Video Time")  + ggtitle("Lidar Left (Video_time)")

multiplot(LR, LL, cols=1)



# Actual riding begins at 0:02:00 in the video.
# Until 2017-07-22 03:54:38
first <- gps[c(139:468),c("time", "lon", "lat", "video_time", "way", "speed")]
second <- gps[c(474:nrow(gps)),c("time", "lon", "lat", "video_time", "way", "speed")]

prox_first <- prox[c(723:1825),]
prox_second <- prox[c(1826:nrow(prox)),]

first_join <- prox_first %>% left_join(first, by=c("time"))

first_join$seq <- paste(as.character(first_join$video_time), as.character(first_join$id), sep="_")
first_join$seq <- as.factor(first_join$seq)

#Video-time-based high-resolution graph
LR <- ggplot(first_join, aes(x = video_time)) +
      geom_line(aes(y = LidarRight), color="black") +
      geom_point(aes(y = LidarRight),size = 0.5, color="red")  +      
      ylim(c(0,9000))  + 
      scale_x_datetime(breaks=date_breaks("30 sec"), labels=date_format("%H:%M:%S")) +      
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Dummy Time (x200ms)")  + ggtitle("Lidar Right (Raw Data)") 

LL <- ggplot(first_join, aes(x = video_time)) +
      geom_line(aes(y = LidarLeft), color="black") +
      geom_point(aes(y = LidarLeft),size = 0.5, color="red")  +       
      ylim(c(0,9000))  + 
      scale_x_datetime(breaks=date_breaks("10 sec"), labels=date_format("%H:%M:%S")) +
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Dummy Time (x200ms)")  + ggtitle("Lidar Left (Raw Data)")

multiplot(LR, LL, cols=1)

# Close-up
LR <- ggplot(first_join[c(500:550),], aes(x = id)) +
      geom_line(aes(y = LidarRight), color="black") +
      geom_point(aes(y = LidarRight),size = 0.5, color="red")  + 
      geom_line(aes(y=100*(speed)), color="blue") + 
      geom_point(aes(y=100*(speed)),size = 0.5, color="blue")  +
      ylim(c(0,3000))  + 
#       scale_x_datetime(breaks=date_breaks("30 sec"), labels=date_format("%H:%M:%S")) +      
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Dummy Time (x200ms)")  + ggtitle("Lidar Right (Raw Data)") 

LL <- ggplot(first_join[c(500:550),], aes(x = id)) +
      geom_line(aes(y = LidarLeft), color="black") +
      geom_point(aes(y = LidarLeft),size = 0.5, color="red")  + 
      geom_line(aes(y=100*(speed)), color="blue") + 
      geom_point(aes(y=100*(speed)),size = 0.5, color="blue")  +
      ylim(c(0,3000))  + 
#       scale_x_datetime(breaks=date_breaks("10 sec"), labels=date_format("%H:%M:%S")) +
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Distance (cm)") + 
      xlab("Dummy Time (x200ms)")  + ggtitle("Lidar Left (Raw Data)")

multiplot(LR, LL, cols=1)

```


# Time domain to Distance domain
```{r}
first_join$dist <- 0
time_interval <- 0.2994975 #seconds

# distance intervals (just for reference)
dists <- as.vector(c(0))

for (i in c(1:nrow(first_join))){
  if (i==nrow(first_join)) break
  sp <- first_join[i,]$speed * 0.514444444 # changing the speed to meters/sec
  first_join[i+1,]$dist <- first_join[i,]$dist + (sp * time_interval)
  dists[i] <- (sp * time_interval)
}

#Distance-based plot
LR <- ggplot(first_join, aes(x = dist)) +
      geom_line(aes(y = LidarRight), color="black") +
      geom_point(aes(y = LidarRight),size = 0.5, color="red")  +      
      ylim(c(0,9000))  +       
      scale_x_continuous(breaks =seq(0, 1550, 50)) + 
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Lidar Distance (cm)") + 
      xlab("Distance Traveled (m)")  + ggtitle("Lidar Right (Distance-based)") 

LL <- ggplot(first_join, aes(x = dist)) +
      geom_line(aes(y = LidarLeft), color="black") +
      geom_point(aes(y = LidarLeft),size = 0.5, color="red")  +       
      ylim(c(0,9000))  +       
      scale_x_continuous(breaks = seq(0, 1550, 50)) + 
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Lidar Distance (cm)") + 
      xlab("Distance Traveled (m)")  + ggtitle("Lidar Left (Distance-based)")

multiplot(LR, LL, cols=1)


# Close-up
LR <- ggplot(first_join[c(600:650),], aes(x = dist)) +
      geom_line(aes(y = LidarRight), color="black") +
      geom_point(aes(y = LidarRight),size = 1, color="red")  +      
      ylim(c(0,2600))  +       
      scale_x_continuous(breaks =seq(775, 835, 5)) + 
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Lidar Distance (cm)") + 
      xlab("Distance Traveled (m)")  + ggtitle("Lidar Right (Distance-based), Close-up") 

LL <- ggplot(first_join[c(600:650),], aes(x = dist)) +
      geom_line(aes(y = LidarLeft), color="black") +
      geom_point(aes(y = LidarLeft),size = 1, color="red")  +       
      ylim(c(0,2600))  +       
      scale_x_continuous(breaks = seq(775, 835, 5)) + 
      theme_bw() + theme(legend.text=element_text(size=15)) + ylab(label="Lidar Distance (cm)") + 
      xlab("Distance Traveled (m)")  + ggtitle("Lidar Left (Distance-based), Close-up")

multiplot(LR, LL, cols=1)

# Saving the first_join
write.table(first_join, "first_part_distance_based.csv", row.names=F, col.names=T, sep=",")

# Adjusting data points into regular ones



```






